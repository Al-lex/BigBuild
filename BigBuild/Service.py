import os
from os import listdir
from os.path import isfile
from os.path import join as joinpath
import shutil

import zipfile


class Service(object):
    """????????? ????????? ???????"""
    def CreateScriptsForDBUpdateServicePack(self,pathbase,pathtempscripts):
                    """???????? ?? ?????? ??????? ????? ?????? ?????? ??? ?????????? ???????????
                     -pathbase -???? ? ???????? ????? ??????
                     -pathtempscripts - ???? ? ????? ? ??????? ????? ??????????? ???????"""
                   # pathbase = r"\\bg\Builds\Master-Tour\Release"
              
                   #?????????? ?????????? ? ????? ???? ?????? ????? ? ??????? ?????????
                    l=listdir(pathbase)
                    l2=[]
                    for i in l:
                        if "Release9.2.20." in i:
                            if i[:16][-1]=="(":
                                 i=i[:14]+"0"+i[14]
                                 l2.append (i[:16])
                                
                            else:
                                 l2.append (i[:16])

                    l2.sort()


                    #??????????? ? ?????????? ? ?????????? ???? ? ?????? 
                    for i2 in l:
                        if l2[-1] in i2:
                           # pathtozips=r'\\bg\\Builds\\Master-Tour\\Release\\'+i2
                           pathtozips=pathbase+i2


                    #path to zip
                    l3=listdir(pathtozips)

                    for i3 in l3:
                       if "scripts" in i3:
                           fullpathtozip=pathtozips+r"\\"+i3

                    #unzip ? ???????? ?????
                    #tempscrpts='E:\TEMPSCRPTS'
                  

                    if os.path.exists( pathtempscripts):
                     shutil.rmtree(pathtempscripts)


                    os.mkdir(pathtempscripts)



                    zip=zipfile.ZipFile( fullpathtozip)
                    zip.extractall(tempscrpts)

                    #??????? ???? ??? ???????

       

                    l4=[ln1 for ln1 in listdir(tempscrpts) if "ReleaseScript2009.2.20." in ln1]



               

                    l5=[]
                    for ln2 in l4:
                        if ln2[-6]==".":
                            ln2=ln2[:-5]+"0"+ln2[-5:]
                            l5.append(ln2)

                        else:
                            l5.append(ln2)  


                    l6=[ln2 for ln2 in l5 if ln2[-6:-4]>"21"]

          




                    #??????? ???????? ?????? ? ??????? ??????????
                    tempfolder=os.getcwd()+"\temp"
                    if os.path.exists(tempfolder):
                     shutil.rmtree(tempfolder)


                    os.mkdir(tempfolder)

                    #? ??????? ?????????? ?????? ???? ???? ??????? ??????? myTemplate.txt ?? ????????? Placeholder ???? ?????? ???? ? ??????
                    template=open(os.getcwd()+"myTemplate.txt","r")
                    updatestring=template.read()
                    template.close()
                    updatestringsplitted=updatestring.split("Placeholder")


                    l7=[]
                    for i4 in l6:
                       l7.append(updatestringsplitted[0]+i4+updatestringsplitted[1]+i4+updatestringsplitted[2])
                    #??????? ????????? ??????? -??????? ???? ready.bat ? ????? ? ????
                    #print(l5)
                    finalfile=open(os.getcwd()+"\temp\ready.bat","w")
                    for line in l7:
                             finalfile.writelines(line)

                    finalfile.close() 
                   #?????????? ???? ? ?????????? ????? ? ?????????? ???
                    return os.getcwd()+"\temp\ready.bat"      

         

